import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { apiRequest } from '@/lib/queryClient';

interface FileTreeEntry {
  name: string;
  type: 'file' | 'directory';
  path: string;
  size?: number;
  extension?: string;
  children?: FileTreeEntry[];
  isExpanded?: boolean;
}

interface FileTreeExplorerProps {
  onFileSelect: (filePath: string, content: string) => void;
  selectedAgent: string;
}

export function FileTreeExplorer({ onFileSelect, selectedAgent }: FileTreeExplorerProps) {
  const [fileTree, setFileTree] = useState<FileTreeEntry[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [expandedDirs, setExpandedDirs] = useState<Set<string>>(new Set(['client', 'server', 'shared']));

  // Load initial directory structure
  useEffect(() => {
    loadDirectory('.');
  }, []);

  const loadDirectory = async (dirPath: string) => {
    setIsLoading(true);
    try {
      const response = await apiRequest('POST', '/api/admin/agent/browse-directory', {
        agentId: selectedAgent,
        dirPath: dirPath === '.' ? '.' : dirPath,
        adminToken: 'sandra-admin-2025'
      });

      if (response.ok) {
        const data = await response.json();
        if (dirPath === '.') {
          // Root directory - set initial tree
          setFileTree(data.entries || []);
        } else {
          // Nested directory - update tree
          updateTreeWithChildren(dirPath, data.entries || []);
        }
      }
    } catch (error) {
      console.error('Failed to load directory:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const updateTreeWithChildren = (dirPath: string, children: FileTreeEntry[]) => {
    setFileTree(prevTree => updateTreeRecursively(prevTree, dirPath, children));
  };

  const updateTreeRecursively = (tree: FileTreeEntry[], targetPath: string, children: FileTreeEntry[]): FileTreeEntry[] => {
    return tree.map(entry => {
      if (entry.type === 'directory' && entry.path === targetPath) {
        return { ...entry, children, isExpanded: true };
      } else if (entry.children) {
        return { ...entry, children: updateTreeRecursively(entry.children, targetPath, children) };
      }
      return entry;
    });
  };

  const toggleDirectory = async (dirPath: string) => {
    if (expandedDirs.has(dirPath)) {
      // Collapse
      setExpandedDirs(prev => {
        const newSet = new Set(prev);
        newSet.delete(dirPath);
        return newSet;
      });
    } else {
      // Expand and load if needed
      setExpandedDirs(prev => new Set([...prev, dirPath]));
      await loadDirectory(dirPath);
    }
  };

  const handleFileClick = async (filePath: string) => {
    if (filePath.match(/\.(ts|tsx|js|jsx|css|md|json|txt|html)$/)) {
      try {
        // Check if multi-tab editor is available and use it
        if ((window as any).openFileInMultiTabEditor) {
          (window as any).openFileInMultiTabEditor(filePath);
          return;
        }

        // Fallback to original behavior
        const response = await apiRequest('POST', '/api/admin/agent/read-file', {
          agentId: selectedAgent,
          filePath: filePath,
          adminToken: 'sandra-admin-2025'
        });

        if (response.ok) {
          const data = await response.json();
          onFileSelect(filePath, data.content || '');
        }
      } catch (error) {
        console.error('Failed to read file:', error);
      }
    }
  };

  const renderTreeEntry = (entry: FileTreeEntry, level: number = 0) => {
    const isExpanded = expandedDirs.has(entry.path);
    const paddingLeft = level * 16;
    
    const matchesSearch = !searchTerm || 
      entry.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      entry.path.toLowerCase().includes(searchTerm.toLowerCase());

    if (!matchesSearch && entry.type === 'file') return null;

    return (
      <div key={entry.path}>
        <div
          className={`flex items-center py-1 px-2 hover:bg-gray-50 cursor-pointer text-sm`}
          style={{ paddingLeft: `${paddingLeft + 8}px` }}
          onClick={() => entry.type === 'directory' ? toggleDirectory(entry.path) : handleFileClick(entry.path)}
        >
          {entry.type === 'directory' && (
            <span className="mr-2 text-xs select-none">
              {isExpanded ? '▼' : '▶'}
            </span>
          )}
          <span className={`${entry.type === 'directory' ? 'font-medium' : ''} truncate flex-1`}>
            {entry.name}
          </span>
          {entry.type === 'file' && entry.size && (
            <span className="text-xs text-gray-400 ml-2">
              {formatFileSize(entry.size)}
            </span>
          )}
        </div>
        
        {entry.type === 'directory' && isExpanded && entry.children && (
          <div>
            {entry.children
              .filter(child => !searchTerm || 
                child.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                child.type === 'directory')
              .map(child => renderTreeEntry(child, level + 1))}
          </div>
        )}
      </div>
    );
  };

  const formatFileSize = (bytes: number): string => {
    if (bytes < 1024) return `${bytes}B`;
    if (bytes < 1024 * 1024) return `${Math.round(bytes / 1024)}KB`;
    return `${Math.round(bytes / (1024 * 1024))}MB`;
  };

  const filteredTree = searchTerm 
    ? fileTree.filter(entry => 
        entry.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        entry.type === 'directory')
    : fileTree;

  return (
    <div className="h-full flex flex-col">
      {/* Search Header */}
      <div className="p-3 border-b border-gray-200">
        <Input
          placeholder="Search files..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="text-sm border-black focus:border-black"
        />
      </div>

      {/* File Tree */}
      <div className="flex-1 overflow-y-auto max-h-full">
        {isLoading && (
          <div className="p-4 text-center text-sm text-gray-500">
            Loading...
          </div>
        )}
        
        {!isLoading && filteredTree.length === 0 && (
          <div className="p-4 text-center text-sm text-gray-500">
            No files found
          </div>
        )}

        {!isLoading && filteredTree.map(entry => renderTreeEntry(entry))}
      </div>

      {/* Quick Actions */}
      <div className="p-3 border-t border-gray-200 space-y-2">
        <Button
          variant="outline"
          size="sm"
          className="w-full text-xs border-black text-black hover:bg-black hover:text-white"
          onClick={() => loadDirectory('.')}
        >
          Refresh Tree
        </Button>
        <Button
          variant="outline"
          size="sm"
          className="w-full text-xs border-black text-black hover:bg-black hover:text-white"
          onClick={() => setExpandedDirs(new Set(['client', 'server', 'shared']))}
        >
          Collapse All
        </Button>
      </div>
    </div>
  );
}